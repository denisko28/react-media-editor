!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("lodash"),require("react")):"function"==typeof define&&define.amd?define(["exports","lodash","react"],t):t(e["react-media-editor"]={},e.lodash,e.React)}(this,function(e,i,c){"use strict";function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function s(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){h(t,e,n[e])})}return t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?p(e):t}function m(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}c=c&&c.hasOwnProperty("default")?c.default:c;var v=function e(t,n,r,o,a){var i=this;u(this,e),h(this,"drawVideo",function(e){var t=i.media,n=i.ctx,r=i.ratio,o=i.canvas.width,a=i.canvas.width/r;n.drawImage(t,0,0,o,a),t.paused||t.ended||e||setTimeout(i.drawVideo,1e3/24),!e&&i.drawCallback&&i.drawCallback()}),h(this,"onPlayPauseHandler",function(){i.media.paused?i.media.play():i.media.pause()}),h(this,"destroy",function(){i.media.removeEventListener("play",i.playListener,!1),i.media.paused||i.media.pause(),i.media.remove(),delete i.media}),this.canvas=t,this.ctx=n,this.media=r,this.ratio=o,this.drawCallback=a,this.playListener=function(){return i.drawVideo()},r.addEventListener("play",this.playListener,!1)},g=function(e){function s(e){var t;u(this,s),h(p(p(t=f(this,d(s).call(this,e)))),"onColorPicked",function(e){return t.props.onColorChange(e)}),h(p(p(t)),"togglePicker",function(){t.setState(function(e){return{showPicker:!e.showPicker}})}),h(p(p(t)),"renderToolsItem",function(e,t){return c.createElement("div",{onClick:e.onClick,key:t,className:"tools-item"},e.name)}),h(p(p(t)),"toggleOpen",function(){t.setState(function(e){return{opened:!e.opened}})});var n=e.onToolsChange,r=e.onUndo,o=e.onClear,a=e.onSave,i=e.onClose;return t.state={opened:!1,showPicker:!1},t.toolsItems=[{name:"Pencil",onClick:function(){return n(0)}},{name:"Line",onClick:function(){return n(1)}},{name:"Arrow",onClick:function(){return n(2)}},{name:"Elipse",onClick:function(){return n(3)}},{name:"Rectangle",onClick:function(){return n(4)}},{name:"Text",onClick:function(){return n(5)}},{name:"Color",onClick:t.togglePicker},{name:"Undo",onClick:r},{name:"Clear",onClick:o},{name:"Save",onClick:a},{name:"Close",onClick:function(){t.toggleOpen(),i()}}],t}return l(s,c.Component),n(s,[{key:"render",value:function(){var n=this,e=this.props.picker;return c.createElement("div",{className:"canvas-painter-tools",style:{display:"flex"}},!this.state.opened&&c.createElement("div",{style:{marginRight:24,fontSize:18,color:"#fff",fontWeight:"bold",padding:10,border:"2px solid #fff",borderRadius:4,fontFamily:"Arial, Helvetica, sans-serif",cursor:"pointer",transition:"300ms ease all"},className:"tools-item",onClick:this.toggleOpen},"Open Tools"),this.state.opened&&c.createElement(c.Fragment,null,this.toolsItems.map(function(e,t){return n.renderToolsItem(e,t)}),this.state.showPicker&&c.createElement(e,{style:{position:"absolute",top:70,left:50},onChangeComplete:this.onColorPicked})))}}]),s}(),a=function e(t,n,r,o,a){u(this,e),this.x=t,this.y=n,this.text=r,this.color=o,this.textSize=a},y=Object.freeze({Pencil:0,Line:1,Arrow:2,Elipse:3,Rectangle:4,Text:5,Shape:6}),w=function e(t,n,r,o,a,i){u(this,e),this.x1=t,this.y1=n,this.x2=r,this.y2=o,this.color=a,this.type=i},x=function e(t){u(this,e),this.data=t},b=function e(){var d=this;u(this,e),h(this,"init",function(e){d.canvasPainter=e.canvasPainter,d.canvas=e.canvas,d.ctx=e.ctx,d.brushColor=e.brushColor,d.brushSize=e.brushSize,d.textSize=e.textSize,d.width=e.width,d.height=e.height,d.forceRedraw=e.forceRedraw,d.tool=y.Pencil,d.isMouseDown=!1,d.hasInput=!1,d.textPosition={},d.startDrawIdx=[],d.pathsArray=[],d.shapesArray=[],d.textsArray=[],d.history=[]}),h(this,"onRedraw",function(){d.pathsArray.forEach(function(e){return e.data.forEach(function(e){return d.drawPath(e)})}),d.shapesArray.forEach(function(e){return d.drawShape(e)}),d.textsArray.forEach(function(e){return d.drawText(e)}),d.isMouseDown&&d.tool===y.Shape&&d.drawCurrentShape()}),h(this,"onMouseUp",function(e){d.isMouseDown=!1;var t=[y.Line,y.Arrow,y.Elipse,y.Rectangle];if(i.includes(t,d.tool)){var n=d.getMousePos(e),r=n.x,o=n.y,a=new w(d.shapeStart.x,d.shapeStart.y,r,o,d.brushColor,d.tool);d.shapesArray.push(a),d.history.push(y.Shape)}}),h(this,"onMouseDown",function(e){if(d.tool!==y.Pencil)return d.tool!==y.Text||d.hasInput?void d.drawShapeStart(e):(d.textPosition=d.getMousePos(e),void d.addTextInput(d.textPosition));d.drawPathStart(e)}),h(this,"onMouseMove",function(e){d.ctx&&d.isMouseDown&&(d.tool!==y.Pencil?d.drawCurrentShape(e):d.drawPaths(e))}),h(this,"getMousePos",function(e){var t=d.canvas.getBoundingClientRect(),n=e.clientX,r=e.clientY;return e.touches&&0<e.touches.length&&(n=e.touches[0].clientX,r=e.touches[0].clientY),{x:n-t.left,y:r-t.top}}),h(this,"addTextInput",function(e){var t=e.x,n=e.y,r=d.canvas.parentNode,o=document.createElement("input");r.appendChild(o),o.style.position="absolute",o.style.outline="none",o.style.border="none",o.style.background="transparent",o.style.fontWeight="bold",o.style.zIndex="1000",o.style.borderBottom="2px solid ".concat(d.brushColor),o.style.fontSize=d.textSize,o.style.color=d.brushColor,o.style.left="".concat(t,"px"),o.style.top="".concat(n+d.textSize,"px"),o.autofocus=!0,o.onkeydown=d.handleTextEnter,o.focus(),d.hasInput=!0}),h(this,"handleTextEnter",function(e){if(13===e.keyCode){var t=d.textPosition,n=t.x,r=t.y,o=new a(n,r,e.target.value,d.brushColor,d.textSize);e.target.remove(),d.hasInput=!1,d.textsArray.push(o),d.history.push(y.Text),d.drawText(o)}}),h(this,"drawText",function(e){var t=d.ctx,n=e.x,r=e.y,o=e.text,a=e.color,i=e.textSize;t.textBaseline="top",t.textAlign="left",t.fillStyle=a,t.font="".concat(i-2,"px Arial"),t.fillText(o,n,r-i-4)}),h(this,"drawPathStart",function(e){d.isMouseDown=!0,d.startDrawIdx.push(d.pathsArray.length);var t=d.getMousePos(e),n=t.x,r=t.y;d.x=n,d.y=r,d.drawPaths(e,!0)}),h(this,"drawPaths",function(e,t){var n=d.getMousePos(e),r=n.x+1,o=n.y+1,a={color:d.brushColor,size:d.brushSize,startX:d.x,startY:d.y,endX:r,endY:o};if(d.drawPath(a),t){var i=[a];d.pathsArray.push(new x(i)),d.history.push(y.Pencil)}d.pathsArray[d.pathsArray.length-1].data.push(a),d.x=r,d.y=o}),h(this,"drawPath",function(e){d.ctx.strokeStyle=e.color,d.ctx.lineWidth=e.size,d.ctx.lineCap="round",d.ctx.beginPath(),d.ctx.moveTo(e.startX,e.startY),d.ctx.lineTo(e.endX,e.endY),d.ctx.stroke()}),h(this,"drawShapeStart",function(e){d.isMouseDown=!0,d.shapeStart=d.getMousePos(e)}),h(this,"drawCurrentShape",function(e){if(e){var t=d.getMousePos(e),n=t.x,r=t.y,o=new w(d.shapeStart.x,d.shapeStart.y,n,r,d.brushColor,d.tool);d.currentShape=o,d.ctx.clearRect(0,0,d.canvas.width,d.canvas.height),d.forceRedraw(),d.canvasPainter.redraw(),d.drawShape(o)}else d.currentShape&&d.drawShape(d.currentShape)}),h(this,"drawShape",function(e){var t=d.ctx,n=e.x1,r=e.y1,o=e.x2,a=e.y2,i=e.color,s=e.type;switch(t.beginPath(),t.strokeStyle=i,t.lineWidth=d.brushSize,t.lineJoin="round",t.lineCap="round",s){case y.Arrow:case y.Line:t.moveTo(n,r),t.lineTo(o,a);break;case y.Elipse:d.drawElipse(e);break;case y.Rectangle:t.rect(n,r,o-n,a-r)}t.stroke(),s===y.Arrow&&d.drawArrowTip(e)}),h(this,"drawArrowTip",function(e){var t=d.ctx,n=e.x1,r=e.y1,o=e.x2,a=e.y2,i=Math.atan2(a-r,o-n);t.beginPath(),t.moveTo(o,a),t.lineTo(o-10*Math.cos(i-Math.PI/6),a-10*Math.sin(i-Math.PI/6)),t.moveTo(o,a),t.lineTo(o-10*Math.cos(i+Math.PI/6),a-10*Math.sin(i+Math.PI/6)),t.stroke()}),h(this,"drawElipse",function(e){var t=e.x1,n=e.y1,r=e.x2,o=e.y2,a=d.ctx,i=.5*(r-t),s=.5*(o-n),c=t+i,l=n+s,u=.01,h=2*Math.PI-.01;for(a.moveTo(c+i*Math.cos(0),l+s*Math.sin(0));u<h;u+=.01)a.lineTo(c+i*Math.cos(u),l+s*Math.sin(u))}),h(this,"onUndo",function(){switch(d.history.pop()){case y.Text:d.textsArray.pop();break;case y.Pencil:d.pathsArray.pop();break;case y.Shape:d.shapesArray.pop()}d.canvasPainter.redraw()}),h(this,"onClear",function(){d.pathsArray=[],d.shapesArray=[],d.textsArray=[],d.forceRedraw(),d.canvasPainter.redraw()}),h(this,"onSave",function(){var e=d.canvas.toDataURL("image/png"),t=document.createElement("a");t.href=e,t.download="".concat((new Date).getTime(),".png"),document.body.appendChild(t),t.click(),document.body.removeChild(t)}),h(this,"onToolsChange",function(e){d.tool=e}),h(this,"onColorChange",function(e){d.brushColor=e.hex,d.canvasPainter.redraw()})},C=function(e){function t(e){var r;return u(this,t),h(p(p(r=f(this,d(t).call(this,e)))),"changeSize",function(){var e=r.state.ratio;r.setState({width:r.canvas.offsetWidth,height:r.canvas.offsetWidth/e});var t=r.canvas.parentNode;setTimeout(function(){r.setState({width:t.offsetWidth,height:t.offsetWidth/e}),r.redraw(),r.forceUpdate()},100)}),h(p(p(r)),"redraw",function(){var e=r.props,t=e.beforeRender,n=e.afterRender;t&&t(),r.controller.onRedraw(),n&&n()}),r.controller=new b,r.state={ratio:e.ratio,width:e.width,height:e.height},r}return l(t,c.Component),n(t,[{key:"componentDidMount",value:function(){this.controller.init(s({canvas:this.canvas,ctx:this.ctx,canvasPainter:this},this.props)),this.changeSize(),window.addEventListener("resize",this.changeSize)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.changeSize)}},{key:"render",value:function(){var t=this,e=this.state,n=e.width,r=e.height,o=this.props,a=o.style,i=o.children;return c.createElement("div",{className:"canvas-painter"},c.createElement(g,{onUndo:this.controller.onUndo,onClear:this.controller.onClear,onSave:this.controller.onSave,onToolsChange:this.controller.onToolsChange,onColorChange:this.controller.onColorChange}),c.createElement("canvas",{ref:function(e){e&&(t.canvas=e,t.ctx=e.getContext("2d"))},style:s({display:"block",touchAction:"none"},a),width:n,height:r,onClick:function(){return!1},onMouseDown:this.controller.onMouseDown,onMouseUp:this.controller.onMouseUp,onMouseMove:this.controller.onMouseMove,onMouseOut:function(){t.controller.isMouseDown=!1},onTouchStart:this.controller.onMouseDown,onTouchMove:this.controller.onMouseMove,onTouchEnd:this.controller.onMouseUp,onTouchCancel:function(){t.controller.isMouseDown=!1}}),i)}}]),t}();h(C,"defaultProps",{width:400,height:400,ratio:16/9,brushColor:"#f33",brushSize:10,textSize:18});var k=function(e){var t=e.width,n=e.height,r=e.style;return c.createElement("svg",{width:t,height:n,style:r,viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},c.createElement("path",{d:"M1664 192v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45zm-896 0v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45z"}))},E=function(e){var t=e.width,n=e.height,r=e.style;return c.createElement("svg",{width:t,height:n,style:r,viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},c.createElement("path",{d:"M1576 927l-1328 738q-23 13-39.5 3t-16.5-36v-1472q0-26 16.5-36t39.5 3l1328 738q23 13 23 31t-23 31z"}))},P=function(e){var t=e.width,n=e.height,r=e.style;return c.createElement("svg",{width:t,height:n,style:r,viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},c.createElement("path",{d:"M832 352v1088q0 26-19 45t-45 19-45-19l-333-333h-262q-26 0-45-19t-19-45v-384q0-26 19-45t45-19h262l333-333q19-19 45-19t45 19 19 45zm384 544q0 76-42.5 141.5t-112.5 93.5q-10 5-25 5-26 0-45-18.5t-19-45.5q0-21 12-35.5t29-25 34-23 29-36 12-56.5-12-56.5-29-36-34-23-29-25-12-35.5q0-27 19-45.5t45-18.5q15 0 25 5 70 27 112.5 93t42.5 142zm256 0q0 153-85 282.5t-225 188.5q-13 5-25 5-27 0-46-19t-19-45q0-39 39-59 56-29 76-44 74-54 115.5-135.5t41.5-173.5-41.5-173.5-115.5-135.5q-20-15-76-44-39-20-39-59 0-26 19-45t45-19q13 0 26 5 140 59 225 188.5t85 282.5zm256 0q0 230-127 422.5t-338 283.5q-13 5-26 5-26 0-45-19t-19-45q0-36 39-59 7-4 22.5-10.5t22.5-10.5q46-25 82-51 123-91 192-227t69-289-69-289-192-227q-36-26-82-51-7-4-22.5-10.5t-22.5-10.5q-39-23-39-59 0-26 19-45t45-19q13 0 26 5 211 91 338 283.5t127 422.5z"}))},S=function(e){var t=e.width,n=e.height,r=e.style;return c.createElement("svg",{width:t,height:n,style:r,viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},c.createElement("path",{d:"M1280 352v1088q0 26-19 45t-45 19-45-19l-333-333h-262q-26 0-45-19t-19-45v-384q0-26 19-45t45-19h262l333-333q19-19 45-19t45 19 19 45z"}))},M=function(e){var t=e.playbackHandler,n=e.paused,r={width:"20px",height:"20px",margin:"10px 10"};return c.createElement("div",{onClick:t,style:{height:"40px",border:"none",backgroundColor:"inherit",cursor:"pointer"}},n?c.createElement(E,{style:r}):c.createElement(k,{style:r}))},T=function(e){var t=e.time;return c.createElement("div",{style:{height:"40px",lineHeight:"40px",fontSize:"1rem",fontFamily:"Arial",width:230}},t)},A=function(e){var t=e.value,n=e.progressClickHandler;return c.createElement("progress",{onClick:n,min:"0",max:"100",value:t,style:{width:"calc(100% - 230px)",margin:"0 20px",height:"40px",cursor:"pointer"}})},z=function(e){var t,n=e.volumeHandler,r=e.muteHandler,o=e.volume,a=e.muted,i={width:"20px",height:"20px",margin:"10px 10"},s=(h(t={width:"calc(100% - 40px)",margin:"0 20px",height:"40px",cursor:"pointer"},"width","calc(30% - 40px)"),h(t,"opacity",a?.2:1),t);return c.createElement(c.Fragment,null,c.createElement("div",{onClick:r,style:{height:"40px",border:"none",backgroundColor:"inherit",cursor:"pointer"}},a?c.createElement(S,{style:i}):c.createElement(P,{style:i})),c.createElement("progress",{onClick:n,min:"0",max:"1",value:o,style:s}))},O=function(e){function t(e){var r;return u(this,t),h(p(p(r=f(this,d(t).call(this,e)))),"timeUpdateHandler",function(){var e=r.props.media,t=e.currentTime?e.currentTime/e.duration*100:0;r.setState({progress:t,timeString:r.getTimeString(e)})}),h(p(p(r)),"playbackListener",function(){var e=r.props.media;r.setState({paused:e.paused})}),h(p(p(r)),"playbackHandler",function(){var e=r.props.media;e.paused?e.play():e.pause(),r.setState({paused:!e.paused})}),h(p(p(r)),"progressClickHandler",function(e){var t=e.nativeEvent.offsetX/e.target.offsetWidth;r.changeMediaProgress(t)}),h(p(p(r)),"changeMediaProgress",function(e){var t=r.props.media;t.currentTime=e*t.duration,(t.paused||t.ended)&&t.play().then(function(){return t.pause()})}),h(p(p(r)),"muteHandler",function(){var e=r.props.media;e.muted=!e.muted,r.setState({muted:e.muted})}),h(p(p(r)),"volumeHandler",function(e){var t=r.props.media;t.volume=e.nativeEvent.offsetX/e.target.offsetWidth,r.setState({volume:t.volume})}),h(p(p(r)),"getTimeString",function(e){var t=r.secondsToHms(e.currentTime),n=r.secondsToHms(e.duration);return"".concat(t," / ").concat(n)}),h(p(p(r)),"secondsToHms",function(e){var t=Number(e);if(!e)return"00:00:00";var n=Math.floor(t/3600),r=Math.floor(t%3600/60),o=Math.floor(t%3600%60);return"".concat(n<10?"0".concat(n):n,":").concat(r<10?"0".concat(r):r,":").concat(o<10?"0".concat(o):o)}),r.state={paused:!0,muted:!1,volume:e.media.volume,timeString:r.getTimeString(e.media),progress:0},r}return l(t,c.Component),n(t,[{key:"componentDidMount",value:function(){var e=this.props.media;e.addEventListener("play",this.playbackListener,!1),e.addEventListener("pause",this.playbackListener,!1),e.addEventListener("timeupdate",this.timeUpdateHandler,!1)}},{key:"componentWillUnmount",value:function(){var e=this.props.media;e.removeEventListener("play",this.playbackListener,!1),e.removeEventListener("pause",this.playbackListener,!1),e.removeEventListener("timeupdate",this.timeUpdateHandler,!1)}},{key:"render",value:function(){var e=this.props.showProgressBar,t=this.state,n=t.paused,r=t.timeString,o=t.progress,a=t.volume,i=t.muted;return c.createElement("div",{style:{display:"flex",backgroundColor:"#d0d0d0",position:"relative",top:"-4px",width:"100%",height:"40px",justifyContent:"flex-start"}},c.createElement(M,{paused:n,playbackHandler:this.playbackHandler}),c.createElement(T,{time:r}),e&&c.createElement(A,{value:o,progressClickHandler:this.progressClickHandler}),c.createElement(z,{volumeHandler:this.volumeHandler,muteHandler:this.muteHandler,volume:a,muted:i}))}}]),t}();h(O,"defaultProps",{showProgressBar:!0});var H=function(e){function a(){var e,t;u(this,a);for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return h(p(p(t=f(this,(e=d(a)).call.apply(e,[this].concat(r))))),"canvasPainter",c.createRef()),h(p(p(t)),"playerDrawCallback",function(){return t.canvasPainter.redraw()}),h(p(p(t)),"forceRedraw",function(){return t.videPlayer.drawVideo(!0)}),t}return l(a,c.Component),n(a,[{key:"componentDidMount",value:function(){this.videPlayer=new v(this.canvasPainter.canvas,this.canvasPainter.ctx,this.props.media,this.props.ratio,this.playerDrawCallback)}},{key:"componentWillUnmount",value:function(){this.videPlayer.destroy()}},{key:"render",value:function(){var e=this.props.media;return c.createElement("div",{style:{width:"100%"}},c.createElement(C,{forceRedraw:this.forceRedraw,ref:this.canvasPainter}),e&&c.createElement(O,{media:e}))}}]),a}(),q=function(e){function o(){var e,i;u(this,o);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return h(p(p(i=f(this,(e=d(o)).call.apply(e,[this].concat(n))))),"renderImage",function(){var e=i.canvasPainter||{},t=e.canvas,n=e.ctx,r=i.props,o=r.image,a=r.ratio;t&&o&&n.drawImage(o,0,0,t.width,t.width/a)}),i}return l(o,c.Component),n(o,[{key:"componentDidMount",value:function(){this.renderImage(),this.canvasPainter=c.createRef()}},{key:"render",value:function(){return this.props.image?c.createElement("div",{style:{width:"100%"}},c.createElement(C,{forceRedraw:this.renderImage,beforeRender:this.renderImage,ref:this.canvasPainter})):null}}]),o}(),D=function(e){function t(e){var l;return u(this,t),h(p(p(l=f(this,d(t).call(this,e)))),"changeSize",function(){l.setState(function(e){return{width:l.canvas.current.offsetWidth,height:l.canvas.current.offsetWidth/e.ratio}});var t=l.canvas.current.parentNode;setTimeout(function(){t&&l.setState(function(e){return{width:t.offsetWidth,height:t.offsetWidth/e.ratio}}),l.state.data&&l.drawData(l.state.data),l.forceUpdate()},300)}),h(p(p(l)),"drawData",function(e){var t=l.state,o=t.width,a=t.height,i=t.stepHeight,n=t.maxSteps,s=p(p(l)).canvas.current.getContext("2d"),c=e.getChannelData(0);if(c.length>2*n){var r=~~(c.length/n);c=c.filter(function(e,t){return t%r==0})}s.save(),s.fillStyle="#000",s.lineWidth=1,s.fillRect(0,0,o,a),s.strokeStyle="#228",s.globalCompositeOperation="lighter",s.translate(0,a/2),s.globalAlpha=.6,c.forEach(function(e,t){var n=Math.floor(o*t/c.length),r=e*a/(1/i*.5);s.beginPath(),s.moveTo(n,0),s.lineTo(n+1,r),s.stroke()}),s.restore()}),h(p(p(l)),"drawProgress",function(e){var t=l.state,n=t.width,r=t.height,o=p(p(l)).canvas.current.getContext("2d");o.font="".concat(r/20,"px Arial"),o.fillStyle="#fff",o.textAlign="center",o.fillText(e,n/2,r/20),o.strokeStyle="#fff",o.lineWidth=2,o.beginPath(),o.moveTo(n*e/100,0),o.lineTo(n*e/100,r),o.stroke()}),h(p(p(l)),"mouseDownHandler",function(e){var t=e.nativeEvent.offsetX/e.target.offsetWidth;l.props.progressClickHandler(t)}),l.state={width:e.width,height:e.width/e.ratio,stepHeight:e.stepHeight,data:null,maxSteps:e.maxSteps,ratio:e.ratio},l.canvas=c.createRef(),l}return l(t,c.Component),n(t,[{key:"componentDidMount",value:function(){var t=this;window.AudioContext=window.AudioContext||window.webkitAudioContext;var e,n,r=new AudioContext,o=function(){console.log("error while decoding your file.")};e=this.props.src,(n=new XMLHttpRequest).open("GET",e,!0),n.responseType="arraybuffer",n.onreadystatechange=function(){4===n.readyState&&(200===n.status?r.decodeAudioData(n.response,function(e){t.setState({data:e}),t.drawData(e)},o):console.log("error during the load.Wrong url or cross origin issue"))},n.send(),this.changeSize(),window.addEventListener("resize",this.changeSize)}},{key:"shouldComponentUpdate",value:function(e){return e.progress!==this.props.progress&&this.state.data&&(this.drawData(this.state.data),this.drawProgress(e.progress)),e}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.changeSize)}},{key:"render",value:function(){return c.createElement("canvas",{width:this.state.width,height:this.state.height,onMouseDown:this.mouseDownHandler,ref:this.canvas,style:s({display:"block",touchAction:"none"},this.props.style)})}}]),t}();h(D,"defaultProps",{width:800,ratio:3,stepHeight:4,maxSteps:8e3});var R=function(e){var t={width:"100%",height:40,color:"#fff",fontSize:20,marginBottom:20,backgroundColor:"#448",cursor:"pointer",textAlign:"center",lineHeight:"40px"},n=e.comments,r=e.goToTimeMark;return c.createElement("div",{style:{height:"100%",width:500,padding:20,backgroundColor:"#225"}},n.map(function(e){return c.createElement("div",{style:t,onClick:function(){return r(e.progressMark)},key:e.text.substr(0,e.text.length/2)},e.text)}))},I=function(e){function a(){var e,t;u(this,a);for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return h(p(p(t=f(this,(e=d(a)).call.apply(e,[this].concat(r))))),"state",{visible:!1}),h(p(p(t)),"field",c.createRef()),h(p(p(t)),"showPopup",function(){return t.setState({visible:!0})}),h(p(p(t)),"hidePopup",function(){return t.setState({visible:!1})}),h(p(p(t)),"confirmAction",function(){t.hidePopup(),t.props.successCallback(t.field.value)}),h(p(p(t)),"cancelAction",function(){t.hidePopup(),t.props.cancelCallback()}),t}return l(a,c.Component),n(a,[{key:"render",value:function(){return c.createElement("div",{isOpen:this.state.visible,className:"modal-block",overlayClassName:"modal-wrapper",shouldCloseOnOverlayClick:!0,onRequestClose:this.cancelAction},c.createElement("div",{className:"modal-header"},c.createElement("h4",null,"Add comment")),c.createElement("div",{className:"general-block-body"},c.createElement("div",{style:{width:"100%",height:400,padding:20}},c.createElement("textarea",{style:{width:"100%",height:"100%",backgroundColor:"inherit",border:"1px solid rgba(100,100,255,0.7)",padding:15,fontSize:20,color:"#bbb"},ref:this.field})),c.createElement("div",{className:"modal-footer"},c.createElement("button",{type:"button",className:"btn bottom-action double",onClick:this.cancelAction},"Cancel"),c.createElement("button",{type:"button",className:"btn bottom-action double",onClick:this.confirmAction},"Comment"))))}}]),a}(),L=function(e){function a(){var e,n;u(this,a);for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return h(p(p(n=f(this,(e=d(a)).call.apply(e,[this].concat(r))))),"state",{audio:null,progress:0,comments:[]}),h(p(p(n)),"controlsRef",c.createRef()),h(p(p(n)),"commentsModal",c.createRef()),h(p(p(n)),"audioProgressHandler",function(){var e=n.state.audio;if(e){var t=e.currentTime?e.currentTime/e.duration*100:0;n.setState({progress:t})}}),h(p(p(n)),"progressClickHandler",function(e){n.controlsRef&&n.controlsRef.changeMediaProgress(e)}),h(p(p(n)),"showCommentsPopup",function(){return n.commentsModal.showPopup()}),h(p(p(n)),"successCommentCallback",function(e){var t={text:e,progressMark:n.state.progress/100};n.setState(function(e){return{comments:m(e.comments).concat([t])}})}),n}return l(a,c.Component),n(a,[{key:"componentDidMount",value:function(){var t=this,n=document.createElement("audio"),e=n.src.substr(n.src.lastIndexOf("."));n.src=this.props.src,n.type="audio/".concat(e);window.addEventListener("load",function e(){4===n.readyState?t.setState({audio:n}):setTimeout(e,100)},!1),n.load(),n.addEventListener("timeupdate",this.audioProgressHandler,!1)}},{key:"componentWillUnmount",value:function(){this.state.audio.removeEventListener("timeupdate",this.audioProgressHandler,!1)}},{key:"render",value:function(){return c.createElement("div",{style:{width:"100%",background:"transparent",display:"flex"}},c.createElement("div",{style:{backgroundColor:"#000"}},c.createElement(D,t({progressClickHandler:this.progressClickHandler,progress:this.state.progress},this.props)),this.state.audio&&c.createElement(O,{showProgressBar:!1,ref:this.controlsRef,media:this.state.audio})),c.createElement("aside",null,c.createElement(R,{goToTimeMark:this.progressClickHandler,comments:this.state.comments}),c.createElement("button",{type:"button",style:{width:200,height:64,fontSize:24,marginTop:24},onClick:this.showCommentsPopup},"Add comment"),c.createElement(I,{successCallback:this.successCommentCallback,ref:this.commentsModal})))}}]),a}(),U="TYPE_VIDEO",W="TYPE_AUDIO",j="TYPE_IMAGE",_="TYPE_DOC";e.Editor=function(e){var t=e.type,n=e.media,r=e.ratio,o=e.src;if(!n&&!o)return null;switch(t){case U:return c.createElement(H,{media:n,ratio:r});case j:return c.createElement(q,{image:n,ratio:r});case W:return c.createElement(L,{src:o});case _:return c.createElement("div",null,"Not yet implemented")}},e.TYPE_VIDEO=U,e.TYPE_AUDIO=W,e.TYPE_IMAGE=j,e.TYPE_DOC=_,Object.defineProperty(e,"__esModule",{value:!0})});
