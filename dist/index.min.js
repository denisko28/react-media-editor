!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","react","lodash"],e):e(t["react-media-editor"]={},t.React,t.lodash)}(this,function(t,l,i){"use strict";function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function n(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),r.forEach(function(t){a(e,t,n[t])})}return e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&o(t,e)}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function d(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?p(t):e}l=l&&l.hasOwnProperty("default")?l.default:l;var f=function t(e,n,r,o,a){c(this,t),this.x=e,this.y=n,this.text=r,this.color=o,this.textSize=a},v=Object.freeze({Pencil:0,Line:1,Arrow:2,Elipse:3,Rectangle:4,Text:5,Shape:6}),x=function t(e,n,r,o,a,i){c(this,t),this.x1=e,this.y1=n,this.x2=r,this.y2=o,this.color=a,this.type=i},y=function t(e){c(this,t),this.data=e},w=function t(){var p=this;c(this,t),a(this,"init",function(t){p.canvasPainter=t.canvasPainter,p.canvas=t.canvas,p.ctx=t.ctx,p.textInputRef=t.textInputRef,p.textContainerRef=t.textContainerRef,p.setTextFocus=t.setTextFocus,p.brushColor=t.brushColor,p.brushSize=t.brushSize*t.ratio,p.textSize=500<t.canvasWidth?t.textSize:70,p.width=t.canvasWidth,p.height=t.canvasHeight,p.forceRedraw=t.forceRedraw,p.ratio=t.ratio,p.tool=v.Rectangle,p.isMouseDown=!1,p.hasInput=!1,p.textPosition={},p.startDrawIdx=[],p.pathsArray=[],p.shapesArray=[],p.textsArray=[],p.history=[]}),a(this,"onRedraw",function(){p.pathsArray.forEach(function(t){return t.data.forEach(function(t){return p.drawPath(t)})}),p.shapesArray.forEach(function(t){return p.drawShape(t)}),p.textsArray.forEach(function(t){return p.drawText(t)}),p.isMouseDown&&p.tool===v.Shape&&p.drawCurrentShape()}),a(this,"onMouseUp",function(t){p.isMouseDown=!1;var e=[v.Line,v.Arrow,v.Elipse,v.Rectangle];if(i.includes(e,p.tool)){var n=p.getMousePos(t),r=n.x,o=n.y,a=new x(p.shapeStart.x,p.shapeStart.y,r,o,p.brushColor,p.tool);p.shapesArray.push(a),p.history.push(v.Shape)}}),a(this,"onMouseDown",function(t){if(p.tool!==v.Pencil)return p.tool!==v.Text||p.hasInput?void p.drawShapeStart(t):(p.textPosition=p.getMousePos(t,!0),void p.addTextInput(p.textPosition));p.drawPathStart(t)}),a(this,"onMouseMove",function(t){p.ctx&&p.isMouseDown&&(p.tool!==v.Pencil?p.drawCurrentShape(t):p.drawPaths(t))}),a(this,"getMousePos",function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=p.canvas.getBoundingClientRect(),r=t.clientX,o=t.clientY;return t.changedTouches&&0<t.changedTouches.length&&(r=t.changedTouches[0].clientX,o=t.changedTouches[0].clientY),e?{x:r,y:o}:{x:(r-n.left)*p.ratio,y:(o-n.top)*p.ratio}}),a(this,"addTextInput",function(t){var e=t.x,n=t.y,r=p.textContainerRef.current,o=p.textInputRef.current;o.style.borderBottom="2px solid ".concat(p.brushColor),o.style.color=p.brushColor,o.onblur=p.handleTextEnter,r.style.display="block",r.style.fontSize="".concat(Number(p.textSize),"px"),r.style.left="".concat(e,"px"),r.style.top="".concat(n-p.textSize,"px"),p.setTextFocus(),p.hasInput=!0}),a(this,"cancelText",function(){p.textContainerRef.current.style.display="none",p.textInputRef.current.value="",p.hasInput=!1}),a(this,"handleTextEnter",function(){var t=p.textPosition,e=t.x,n=t.y,r=p.canvas.getBoundingClientRect(),o=new f((e-r.left)*p.ratio,(n-r.top+.5*p.textSize)*p.ratio,p.textInputRef.current.value,p.brushColor,p.textSize*p.ratio);p.textContainerRef.current.style.display="none",p.textInputRef.current.value="",p.hasInput=!1,p.textsArray.push(o),p.history.push(v.Text),p.drawText(o)}),a(this,"drawText",function(t){var e=p.ctx,n=t.x,r=t.y,o=t.text,a=t.color,i=t.textSize;e.textBaseline="top",e.textAlign="left",e.fillStyle=a,e.font="".concat(i,"px Arial"),e.fillText(o,n,r-i-4)}),a(this,"drawPathStart",function(t){p.isMouseDown=!0,p.startDrawIdx.push(p.pathsArray.length);var e=p.getMousePos(t),n=e.x,r=e.y;p.x=n,p.y=r,p.drawPaths(t,!0)}),a(this,"drawPaths",function(t,e){var n=p.getMousePos(t),r=n.x+1,o=n.y+1,a={color:p.brushColor,size:p.brushSize,startX:p.x,startY:p.y,endX:r,endY:o};if(p.drawPath(a),e){var i=[a];p.pathsArray.push(new y(i)),p.history.push(v.Pencil)}p.pathsArray[p.pathsArray.length-1].data.push(a),p.x=r,p.y=o}),a(this,"drawPath",function(t){p.ctx.strokeStyle=t.color,p.ctx.lineWidth=t.size,p.ctx.lineCap="round",p.ctx.beginPath(),p.ctx.moveTo(t.startX,t.startY),p.ctx.lineTo(t.endX,t.endY),p.ctx.stroke()}),a(this,"drawShapeStart",function(t){p.isMouseDown=!0,p.shapeStart=p.getMousePos(t)}),a(this,"drawCurrentShape",function(t){if(t){var e=p.getMousePos(t),n=e.x,r=e.y,o=new x(p.shapeStart.x,p.shapeStart.y,n,r,p.brushColor,p.tool);p.currentShape=o,p.ctx.clearRect(0,0,p.canvas.width,p.canvas.height),p.forceRedraw(),p.canvasPainter.redraw(),p.drawShape(o)}else p.currentShape&&p.drawShape(p.currentShape)}),a(this,"drawShape",function(t){var e=p.ctx,n=t.x1,r=t.y1,o=t.x2,a=t.y2,i=t.color,s=t.type;switch(e.beginPath(),e.strokeStyle=i,e.lineWidth=p.brushSize,e.lineJoin="round",e.lineCap="round",s){case v.Arrow:case v.Line:e.moveTo(n,r),e.lineTo(o,a);break;case v.Elipse:p.drawElipse(t);break;case v.Rectangle:e.rect(n,r,o-n,a-r)}e.stroke(),s===v.Arrow&&p.drawArrowTip(t)}),a(this,"drawArrowTip",function(t){var e=p.ctx,n=t.x1,r=t.y1,o=t.x2,a=t.y2,i=Math.atan2(a-r,o-n);e.beginPath(),e.moveTo(o,a),e.lineTo(o-10*Math.cos(i-Math.PI/6),a-10*Math.sin(i-Math.PI/6)),e.moveTo(o,a),e.lineTo(o-10*Math.cos(i+Math.PI/6),a-10*Math.sin(i+Math.PI/6)),e.stroke()}),a(this,"drawElipse",function(t){var e=t.x1,n=t.y1,r=t.x2,o=t.y2,a=p.ctx,i=.5*(r-e),s=.5*(o-n),c=e+i,h=n+s,u=.01,l=2*Math.PI-.01;for(a.moveTo(c+i*Math.cos(0),h+s*Math.sin(0));u<l;u+=.01)a.lineTo(c+i*Math.cos(u),h+s*Math.sin(u))}),a(this,"onUndo",function(){switch(p.history.pop()){case v.Text:p.textsArray.pop();break;case v.Pencil:p.pathsArray.pop();break;case v.Shape:p.shapesArray.pop()}p.canvasPainter.redraw()}),a(this,"onClear",function(){p.pathsArray=[],p.shapesArray=[],p.textsArray=[],p.forceRedraw(),p.canvasPainter.redraw()}),a(this,"onSave",function(){return p.canvas.toDataURL("image/png")}),a(this,"onToolsChange",function(t){p.tool=t,p.canvasPainter.redraw()}),a(this,"onColorChange",function(t){p.brushColor=t,p.canvasPainter.redraw()}),a(this,"onBrushSizeChange",function(t){p.brushSize=t,p.canvasPainter.redraw()})},g=function(t){function e(t){var r;return c(this,e),a(p(p(r=d(this,h(e).call(this,t)))),"redraw",function(){var t=r.props,e=t.beforeRender,n=t.afterRender;e&&e(),r.controller.onRedraw(),n&&n()}),a(p(p(r)),"handleSave",function(){var t=r.controller.onSave();r.props.onSave(t)}),r.textInput=l.createRef(),r.textContainer=l.createRef(),r.state={canvasWidth:r.props.canvasWidth,canvasHeight:r.props.canvasHeight,ratio:r.props.ratio},r.controller=new w,r.setTextFocus=r.setTextFocus.bind(p(p(r))),r}return s(e,l.Component),n(e,[{key:"componentDidMount",value:function(){this.canvas&&this.controller.init(u({canvas:this.canvas,ctx:this.ctx,canvasPainter:this,textInputRef:this.textInput,textContainerRef:this.textContainer,setTextFocus:this.setTextFocus},this.props))}},{key:"componentDidUpdate",value:function(t){t.canvasWidth!==this.props.canvasWidth&&this.setState({canvasWidth:this.props.canvasWidth,canvasHeight:this.props.canvasHeight,ratio:this.props.ratio}),this.redraw()}},{key:"setTextFocus",value:function(){var t=this;setTimeout(function(){return t.textInput.current.focus()},200)}},{key:"render",value:function(){var e=this,t=this.props,n=t.style,r=t.children,o=this.state,a=o.canvasWidth,i=o.canvasHeight,s=o.ratio,c=a/s,h=i/s;return s&&a&&i?l.createElement(l.Fragment,null,l.createElement("div",{className:"canvas-painter"},l.createElement("canvas",{ref:function(t){t&&(e.canvas=t,e.ctx=t.getContext("2d"))},style:u({background:"#000",display:"block",touchAction:"none",width:c,height:h},n),width:a,height:i,onClick:function(){return!1},onMouseDown:this.controller.onMouseDown,onMouseUp:this.controller.onMouseUp,onMouseMove:this.controller.onMouseMove,onMouseOut:function(){e.controller.isMouseDown=!1},onTouchStart:this.controller.onMouseDown,onTouchMove:this.controller.onMouseMove,onTouchEnd:this.controller.onMouseUp,onTouchCancel:function(){e.controller.isMouseDown=!1}}),l.createElement("div",{ref:this.textContainer,style:{display:"none",position:"fixed",zIndex:"1000"}},l.createElement("input",{ref:this.textInput,autoFocus:!0,style:{outline:"none",border:"none",background:"transparent",lineHeight:"normal",fontSize:"inherit"}}))),r({undo:this.controller.onUndo,clear:this.controller.onClear,save:this.handleSave,setActiveTool:this.controller.onToolsChange,setActiveColor:this.controller.onColorChange,setBrushSize:this.controller.onBrushSizeChange})):l.createElement(l.Fragment,null)}}]),e}();a(g,"defaultProps",{brushColor:"#f33",brushSize:5,textSize:18});var e=function(t){function o(){var t,s;c(this,o);for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return a(p(p(s=d(this,(t=h(o)).call.apply(t,[this].concat(n))))),"canvasPainter",l.createRef()),a(p(p(s)),"state",{canvasWidth:0,canvasHeight:0,ratio:null,media:null}),a(p(p(s)),"renderImage",function(){if(s.canvasPainter){var t=s.canvasPainter||{},e=t.canvas,n=t.ctx,r=s.state,o=r.media,a=r.canvasWidth,i=r.canvasHeight;e&&o&&n.drawImage(o,0,0,a,i)}}),s}return s(o,l.Component),n(o,[{key:"componentDidMount",value:function(){var e=this,t=this.props,n=t.imgSrc,r=t.height,o=t.width,a=new window.Image;a.setAttribute("crossorigin","anonymous"),a.onload=function(){var t=1;o?t=a.width/o:r&&(t=a.height/r),e.setState({canvasWidth:a.width,canvasHeight:a.height,ratio:t,media:a})},a.src=n}},{key:"render",value:function(){var e=this,t=this.props,n=t.imgSrc,r=t.onSave,o=t.style,a=t.loader,i=t.children,s=this.state,c=s.canvasWidth,h=s.canvasHeight,u=s.ratio;return s.media&&n?l.createElement("div",null,l.createElement(g,{onSave:r,forceRedraw:this.renderImage,beforeRender:this.renderImage,canvasWidth:c,canvasHeight:h,ratio:u,style:o,loader:a,ref:function(t){e.canvasPainter=t,e.renderImage()}},i)):l.createElement(l.Fragment,null,a)}}]),o}();t.ImageEditor=e,Object.defineProperty(t,"__esModule",{value:!0})});
