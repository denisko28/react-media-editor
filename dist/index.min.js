!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","react","lodash"],e):e(t["react-media-editor"]={},t.React,t.lodash)}(this,function(t,u,i){"use strict";function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(t){a(e,t,n[t])})}return e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function d(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?p(t):e}u=u&&u.hasOwnProperty("default")?u.default:u;var f=function t(e,n,o,r,a){c(this,t),this.x=e,this.y=n,this.text=o,this.color=r,this.textSize=a},v=Object.freeze({Pencil:0,Line:1,Arrow:2,Elipse:3,Rectangle:4,Text:5,Shape:6}),y=function t(e,n,o,r,a,i){c(this,t),this.x1=e,this.y1=n,this.x2=o,this.y2=r,this.color=a,this.type=i},w=function t(e){c(this,t),this.data=e},x=function t(){var p=this;c(this,t),a(this,"init",function(t){p.canvasPainter=t.canvasPainter,p.canvas=t.canvas,p.ctx=t.ctx,p.brushColor=t.brushColor,p.brushSize=t.brushSize,p.textSize=t.textSize,p.width=t.canvasWidth,p.height=t.canvasHeight,p.forceRedraw=t.forceRedraw,p.ratio=t.ratio,p.tool=v.Pencil,p.isMouseDown=!1,p.hasInput=!1,p.textPosition={},p.startDrawIdx=[],p.pathsArray=[],p.shapesArray=[],p.textsArray=[],p.history=[]}),a(this,"onRedraw",function(){p.pathsArray.forEach(function(t){return t.data.forEach(function(t){return p.drawPath(t)})}),p.shapesArray.forEach(function(t){return p.drawShape(t)}),p.textsArray.forEach(function(t){return p.drawText(t)}),p.isMouseDown&&p.tool===v.Shape&&p.drawCurrentShape()}),a(this,"onMouseUp",function(t){p.isMouseDown=!1;var e=[v.Line,v.Arrow,v.Elipse,v.Rectangle];if(i.includes(e,p.tool)){var n=p.getMousePos(t),o=n.x,r=n.y,a=new y(p.shapeStart.x,p.shapeStart.y,o,r,p.brushColor,p.tool);p.shapesArray.push(a),p.history.push(v.Shape)}}),a(this,"onMouseDown",function(t){if(p.tool!==v.Pencil)return p.tool!==v.Text||p.hasInput?void p.drawShapeStart(t):(p.textPosition=p.getMousePos(t),void p.addTextInput(p.textPosition));p.drawPathStart(t)}),a(this,"onMouseMove",function(t){p.ctx&&p.isMouseDown&&(p.tool!==v.Pencil?p.drawCurrentShape(t):p.drawPaths(t))}),a(this,"getMousePos",function(t){var e=p.canvas.getBoundingClientRect(),n=t.clientX,o=t.clientY;return t.changedTouches&&0<t.changedTouches.length&&(n=t.changedTouches[0].clientX,o=t.changedTouches[0].clientY),{x:(n-e.left)*p.ratio,y:(o-e.top)*p.ratio}}),a(this,"addTextInput",function(t){var e=t.x,n=t.y,o=p.canvas.parentNode,r=document.createElement("input");o.appendChild(r),r.style.position="absolute",r.style.outline="none",r.style.border="none",r.style.background="transparent",r.style.fontWeight="bold",r.style.zIndex="1000",r.style.borderBottom="2px solid ".concat(p.brushColor),r.style.fontSize=p.textSize,r.style.color=p.brushColor,r.style.left="".concat(e,"px"),r.style.top="".concat(n+p.textSize,"px"),r.autofocus=!0,r.onkeydown=p.handleTextEnter,r.focus(),p.hasInput=!0}),a(this,"handleTextEnter",function(t){if(13===t.keyCode){var e=p.textPosition,n=e.x,o=e.y,r=new f(n,o,t.target.value,p.brushColor,p.textSize);t.target.remove(),p.hasInput=!1,p.textsArray.push(r),p.history.push(v.Text),p.drawText(r)}}),a(this,"drawText",function(t){var e=p.ctx,n=t.x,o=t.y,r=t.text,a=t.color,i=t.textSize;e.textBaseline="top",e.textAlign="left",e.fillStyle=a,e.font="".concat(i-2,"px Arial"),e.fillText(r,n,o-i-4)}),a(this,"drawPathStart",function(t){p.isMouseDown=!0,p.startDrawIdx.push(p.pathsArray.length);var e=p.getMousePos(t),n=e.x,o=e.y;p.x=n,p.y=o,p.drawPaths(t,!0)}),a(this,"drawPaths",function(t,e){var n=p.getMousePos(t),o=n.x+1,r=n.y+1,a={color:p.brushColor,size:p.brushSize,startX:p.x,startY:p.y,endX:o,endY:r};if(p.drawPath(a),e){var i=[a];p.pathsArray.push(new w(i)),p.history.push(v.Pencil)}p.pathsArray[p.pathsArray.length-1].data.push(a),p.x=o,p.y=r}),a(this,"drawPath",function(t){p.ctx.strokeStyle=t.color,p.ctx.lineWidth=t.size,p.ctx.lineCap="round",p.ctx.beginPath(),p.ctx.moveTo(t.startX,t.startY),p.ctx.lineTo(t.endX,t.endY),p.ctx.stroke()}),a(this,"drawShapeStart",function(t){p.isMouseDown=!0,p.shapeStart=p.getMousePos(t)}),a(this,"drawCurrentShape",function(t){if(t){var e=p.getMousePos(t),n=e.x,o=e.y,r=new y(p.shapeStart.x,p.shapeStart.y,n,o,p.brushColor,p.tool);p.currentShape=r,p.ctx.clearRect(0,0,p.canvas.width,p.canvas.height),p.forceRedraw(),p.canvasPainter.redraw(),p.drawShape(r)}else p.currentShape&&p.drawShape(p.currentShape)}),a(this,"drawShape",function(t){var e=p.ctx,n=t.x1,o=t.y1,r=t.x2,a=t.y2,i=t.color,s=t.type;switch(e.beginPath(),e.strokeStyle=i,e.lineWidth=p.brushSize,e.lineJoin="round",e.lineCap="round",s){case v.Arrow:case v.Line:e.moveTo(n,o),e.lineTo(r,a);break;case v.Elipse:p.drawElipse(t);break;case v.Rectangle:e.rect(n,o,r-n,a-o)}e.stroke(),s===v.Arrow&&p.drawArrowTip(t)}),a(this,"drawArrowTip",function(t){var e=p.ctx,n=t.x1,o=t.y1,r=t.x2,a=t.y2,i=Math.atan2(a-o,r-n);e.beginPath(),e.moveTo(r,a),e.lineTo(r-10*Math.cos(i-Math.PI/6),a-10*Math.sin(i-Math.PI/6)),e.moveTo(r,a),e.lineTo(r-10*Math.cos(i+Math.PI/6),a-10*Math.sin(i+Math.PI/6)),e.stroke()}),a(this,"drawElipse",function(t){var e=t.x1,n=t.y1,o=t.x2,r=t.y2,a=p.ctx,i=.5*(o-e),s=.5*(r-n),c=e+i,h=n+s,u=.01,l=2*Math.PI-.01;for(a.moveTo(c+i*Math.cos(0),h+s*Math.sin(0));u<l;u+=.01)a.lineTo(c+i*Math.cos(u),h+s*Math.sin(u))}),a(this,"onUndo",function(){switch(p.history.pop()){case v.Text:p.textsArray.pop();break;case v.Pencil:p.pathsArray.pop();break;case v.Shape:p.shapesArray.pop()}p.canvasPainter.redraw()}),a(this,"onClear",function(){p.pathsArray=[],p.shapesArray=[],p.textsArray=[],p.forceRedraw(),p.canvasPainter.redraw()}),a(this,"onSave",function(){return p.canvas.toDataURL("image/png")}),a(this,"onToolsChange",function(t){p.tool=t}),a(this,"onColorChange",function(t){p.brushColor=t}),a(this,"onBrushSizeChange",function(t){p.brushSize=t})},g=function(t){function e(t){var o;return c(this,e),a(p(p(o=d(this,h(e).call(this,t)))),"redraw",function(){var t=o.props,e=t.beforeRender,n=t.afterRender;e&&e(),o.controller.onRedraw(),n&&n()}),a(p(p(o)),"handleSave",function(){var t=o.controller.onSave();o.props.onSave(t)}),o.state={canvasWidth:o.props.canvasWidth,canvasHeight:o.props.canvasHeight,ratio:o.props.ratio},o.controller=new x,o}return s(e,u.Component),n(e,[{key:"componentDidMount",value:function(){this.canvas&&this.controller.init(l({canvas:this.canvas,ctx:this.ctx,canvasPainter:this},this.props))}},{key:"componentDidUpdate",value:function(t){t.canvasWidth!==this.props.canvasWidth&&this.setState({canvasWidth:this.props.canvasWidth,canvasHeight:this.props.canvasHeight,ratio:this.props.ratio})}},{key:"render",value:function(){var e=this,t=this.props,n=t.style,o=t.children,r=this.state,a=r.canvasWidth,i=r.canvasHeight,s=r.ratio,c=a/s,h=i/s;return s&&a&&i?u.createElement(u.Fragment,null,u.createElement("div",{className:"canvas-painter"},u.createElement("canvas",{ref:function(t){t&&(e.canvas=t,e.ctx=t.getContext("2d"))},style:l({background:"#000",display:"block",touchAction:"none",width:c,height:h},n),width:a,height:i,onClick:function(){return!1},onMouseDown:this.controller.onMouseDown,onMouseUp:this.controller.onMouseUp,onMouseMove:this.controller.onMouseMove,onMouseOut:function(){e.controller.isMouseDown=!1},onTouchStart:this.controller.onMouseDown,onTouchMove:this.controller.onMouseMove,onTouchEnd:this.controller.onMouseUp,onTouchCancel:function(){e.controller.isMouseDown=!1}})),o({undo:this.controller.onUndo,clear:this.controller.onClear,save:this.handleSave,setActiveTool:this.controller.onToolsChange,setActiveColor:this.controller.onColorChange,setBrushSize:this.controller.onBrushSizeChange})):u.createElement(u.Fragment,null)}}]),e}();a(g,"defaultProps",{brushColor:"#f33",brushSize:10,textSize:18});var e=function(t){function r(){var t,s;c(this,r);for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return a(p(p(s=d(this,(t=h(r)).call.apply(t,[this].concat(n))))),"canvasPainter",u.createRef()),a(p(p(s)),"state",{canvasWidth:0,canvasHeight:0,ratio:null,media:null}),a(p(p(s)),"renderImage",function(){if(s.canvasPainter){var t=s.canvasPainter||{},e=t.canvas,n=t.ctx,o=s.state,r=o.media,a=o.canvasWidth,i=o.canvasHeight;e&&r&&n.drawImage(r,0,0,a,i)}}),s}return s(r,u.Component),n(r,[{key:"componentDidMount",value:function(){var e=this,t=this.props,n=t.imgSrc,o=t.height,r=t.width,a=new window.Image;a.setAttribute("crossorigin","anonymous"),a.onload=function(){var t=1;r?t=a.width/r:o&&(t=a.height/o),e.setState({canvasWidth:a.width,canvasHeight:a.height,ratio:t,media:a})},a.src=n}},{key:"render",value:function(){var e=this,t=this.props,n=t.imgSrc,o=t.onSave,r=t.children,a=this.state.media;return a&&n&&a?u.createElement("div",{style:{width:"100%"}},u.createElement(g,{onSave:o,forceRedraw:this.renderImage,beforeRender:this.renderImage,canvasWidth:this.state.canvasWidth,canvasHeight:this.state.canvasHeight,ratio:this.state.ratio,ref:function(t){e.canvasPainter=t,e.renderImage()}},r)):null}}]),r}();t.ImageEditor=e,Object.defineProperty(t,"__esModule",{value:!0})});
